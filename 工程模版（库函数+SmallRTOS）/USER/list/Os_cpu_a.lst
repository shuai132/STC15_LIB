A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     1


MACRO ASSEMBLER A51 V8.02
OBJECT MODULE PLACED IN .\list\Os_cpu_a.obj
ASSEMBLER INVOKED BY: d:\Keil_v5\C51\BIN\A51.EXE ..\keilc51\Os_cpu_a.asm SET(SMALL) DEBUG PRINT(.\list\Os_cpu_a.lst) OBJ
                      ECT(.\list\Os_cpu_a.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ;******************************************************************************************
                             ***************
                       2     ;**                                                            Small RTOS 51 
                       3     ;**                                   The Real-Time Kernel For Keil c51
                       4     ;**
                       5     ;**                                  (c) Copyright 2002-2003, chenmingji
                       6     ;**                                           All Rights Reserved
                       7     ;**
                       8     ;**                                                  V1.12.1
                       9     ;**
                      10     ;**
                      11     ;**--------------------ÎÄ¼þÐÅÏ¢------------------------------------------------------------
                             ---------------
                      12     ;**ÎÄ   ¼þ   Ãû: OS_CPU_A.ASM
                      13     ;**´´   ½¨   ÈË: ³ÂÃ÷¼Æ
                      14     ;**°æ        ±¾: V1.12.1
                      15     ;**×îºóÐÞ¸ÄÈÕÆÚ:  2002Äê2ÔÂ5ÈÕ
                      16     ;**Ãè¡¡      Êö:  Small RTOS 51 ÓëCPU(8051ÏµÁÐ)Ïà¹ØµÄ»ã±à³ÌÐò
                      17     ;**---------------------ÀúÊ·°æ±¾ÐÅÏ¢-------------------------------------------------------
                             ---------------
                      18     ;** ´´½¨ÈË: ³ÂÃ÷¼Æ
                      19     ;** °æ  ±¾:V0.50
                      20     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                      21     ;** Ãè¡¡Êö: Ô­Ê¼°æ±¾
                      22     ;**
                      23     ;**----------------------------------------------------------------------------------------
                             --------------
                      24     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      25     ;** °æ  ±¾: V1.00
                      26     ;** ÈÕ¡¡ÆÚ: 2002Äê6ÔÂ10ÈÕ
                      27     ;** Ãè¡¡Êö: Ö§³ÖÈíµÄ·ÇÆÁ±ÎÖÐ¶Ï
                      28     ;**
                      29     ;**----------------------------------------------------------------------------------------
                             --------------
                      30     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      31     ;** °æ  ±¾: V1.10.3
                      32     ;** ÈÕ¡¡ÆÚ: 2002Äê9ÔÂ16ÈÕ
                      33     ;** Ãè¡¡Êö: ÐÞ¸ÄÁËLoadCtx´úÂëÊ¹Ö®Ö´ÐÐ¸ü¿ì£¬´úÂë¸üÐ¡
                      34     ;**         
                      35     ;**----------------------------------------------------------------------------------------
                             --------------
                      36     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      37     ;** °æ  ±¾: V1.10.4
                      38     ;** ÈÕ¡¡ÆÚ: 2002Äê10ÔÂ5ÈÕ
                      39     ;** Ãè¡¡Êö: ½«OS_CPU_A.ASMºÍOS_CPU_A_task16.ASMºÏ²¢
                      40     ;**
                      41     ;**----------------------------------------------------------------------------------------
                             --------------
                      42     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      43     ;** °æ  ±¾: V1.11.0
                      44     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                      45     ;** Ãè¡¡Êö: ¸ù¾ÝÐÂ°æ±¾ÒªÇóÊ¹ÈÎÎñ¶ÑÕ»°üº¬Os_Enter_Sum£¬Ê¹ÓÅÏÈ¼¶×îµÍ
                      46     ;**         µÄÈÎÎñÖ»±£´æÉÙÁ¿¼Ä´æÆ÷£»Ôö¼Ó×¢ÊÍ
                      47     ;**----------------------------------------------------------------------------------------
                             --------------
                      48     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      49     ;** °æ  ±¾: V1.12.0
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     2

                      50     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ30ÈÕ
                      51     ;** Ãè¡¡Êö: ¸ù¾ÝÐÂ°æ±¾ÒªÇó¸ü¸ÄÉÙÁ¿´úÂë
                      52     ;**----------------------------------------------------------------------------------------
                             --------------
                      53     ;** ÐÞ¸ÄÈË: ³ÂÃ÷¼Æ
                      54     ;** °æ  ±¾: V1.12.1
                      55     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ5ÈÕ
                      56     ;** Ãè¡¡Êö: ¸üÕLoadCtxÖÐOS_MAX_TASKSÎª8»ò16µÄbug
                      57     ;**---------------------µ±Ç°°æ±¾ÐÞ¶©-------------------------------------------------------
                             ----------------
                      58     ;** ÐÞ¸ÄÈË:
                      59     ;** ÈÕ¡¡ÆÚ:
                      60     ;** Ãè¡¡Êö:
                      61     ;**
                      62     ;**----------------------------------------------------------------------------------------
                             --------------
                      63     ;******************************************************************************************
                             **************/
                      64     ;#include "OS_CPU.H"
                +1    65     
                +1    66     
                +1    67     
                +1    68     
                +1    69     
                +1    70     
                +1    71     
                +1    72     
                +1    73     
                +1    74     
                +1    75     
                +1    76     
                +1    77     
                +1    78     
                +1    79     
                +1    80     
                +1    81     
                +1    82     
                +1    83     
                +1    84     
                +1    85     
                +1    86     
                +1    87     
                +1    88     
                +1    89     
                +1    90     
                +1    91     
                +1    92     
                +1    93     
                +1    94     
                +1    95     
                +1    96     
                +1    97     
                +1    98     
                +1    99     
                +1   100     
                +1   101     
                +1   102     
                +1   103     
                +1   104     
                +1   105     
                +1   106     
                +1   107     
                +1   108     
                +1   109     
                +1   110     
                +1   111     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     3

                +1   112     
                +1   113     
                +1   114     
                +1   115     
                +1   116     
                +1   117     
                +1   118     
                +1   119     
                +1   120     
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1           
                +1   159     
                +1   160     
                +1   161     
                +1   162     
                +1   163     
                +1   164     SET_EA   MACRO                                                  ;´ò¿ªËùÓÐÔÊÐíÖÐ¶Ï
                +1   165                  SETB     EA
                +1   166              ENDM
                +1   167              
                +1   168     
                     169     
                     170     ;#include "OS_CFG.H"
                +1   171     
                +1   172     
                +1   173     
                +1   174     
                +1   175     
                +1   176     
                +1   177     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     4

                +1   178     
                +1   179     
                +1   180     
                +1   181     
                +1   182     
                +1   183     
                +1   184     
                +1   185     
                +1   186     
                +1   187     
                +1   188     
                +1   189     
                +1   190     
                +1   191     
                +1   192     
                +1   193     
                +1   194     
                +1   195     
                +1   196     
                +1   197     
                +1   198     
                +1   199     
                +1   200     
                +1   201     
                +1   202     
                +1   203     
                +1   204     
                +1   205     
                +1   206     
                +1   207     
                +1   208     
                +1   209     
                +1   210     
                +1   211     
                +1   212     
                +1   213     
                +1   214     
                +1   215     
                +1   216     
                +1   217     
                +1   218     
                +1   219     
                +1   220     
                +1   221     
                +1   222     
                +1   223     
                +1   224     
                +1   225     
                +1   226     
                +1   227     
                +1   228     
                +1   229     
                +1   230     
                +1   231     
                +1   232     
                +1   233     
                +1   234     
                +1   235     
                +1   236     
                +1   237     
                +1   238     
                +1   239     
                +1   240     
                +1   241     
                +1   242     
                +1   243     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     5

                +1   244                                                 
                +1   245     
                +1   246     
                +1   247     
                +1   248     
                +1   249     
                +1   250     
                +1   251     
                +1   252     
                +1   253     
                +1   254     
                +1   255     
                +1   256     
                +1   257     
                +1   258                                                 
                +1   259     
                +1   260     
                +1   261     
                +1   262     
                +1   263     
                +1   264     
                +1   265     
                +1   266     
                +1   267     
                +1   268     
                +1   269     
                +1           
                +1           
                +1   272     
                +1   273     
                +1           
                +1           
                +1           
                +1           
                +1           
                     279     
                     280     
                     281             NAME    OS_CPU_A_ASM
                     282     
                     283     ?PR?OSCtxSw?OS_CPU_A                     SEGMENT CODE ;INBLOCK 
                     284     ?PR?OSIntCtxSw?OS_CPU_A                  SEGMENT CODE ;INBLOCK 
                     285     ?PR?LoadCtx?OS_CPU_A                     SEGMENT CODE ;INBLOCK 
                     286     ?PR?C_OSCtxSw?OS_CPU_C                   SEGMENT CODE 
                     287     
                     288     
                     289             EXTRN   CODE (OSMapTbl)
                     290             EXTRN   DATA (OSFastSwap)
                     291             EXTRN   DATA (OSTaskID)
                     292             EXTRN   DATA (OSNextTaskID)
                     293             EXTRN   DATA (OSTsakStackBotton)
                     294             EXTRN   DATA (Os_Enter_Sum)
                     295     IF 0  <> 0
                                     EXTRN   IDATA (Sp2)
                             ENDIF
                     298     
                     299     
                     300             PUBLIC  LoadCtx
                     301             PUBLIC  OSIntCtxSw
                     302             PUBLIC  OSCtxSw
                     303             PUBLIC  STACK 
                     304     
                     305     ;****************************************************************************************
                     306     ;?STACK SEGMENT IDATA
                     307     
                     308     ?STACK          SEGMENT   IDATA
                     309     
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     6

----                 310                     RSEG    ?STACK
0000                 311     STACK:                                          ;¶ÑÕ»
0000                 312                     DS      1
                     313     
                     314     ;****************************************************************************************
                     315     ;/*****************************************************************************************
                             ****************
                     316     ;** º¯ÊÃû³Æ: LoadCtx
                     317     ;** ¹¦ÄÜÃèÊö: ÈÎÎñ»·¾³»Ö¸´º¯Ê
                     318     ;** Êä¡¡Èë: OSTaskID,OSFastSwap
                     319     ;** Êä¡¡³ö : ÎÞ
                     320     ;** È«¾Ö±äÁ¿: ÎÞ
                     321     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     322     ;** 
                     323     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     324     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     325     ;**----------------------------------------------------------------------------------------
                             ---------------
                     326     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     327     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     328     ;**----------------------------------------------------------------------------------------
                             ---------------
                     329     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     330     ;** ÈÕ¡¡ÆÚ: 2003Äê2ÔÂ5ÈÕ
                     331     ;**----------------------------------------------------------------------------------------
                             ---------------
                     332     ;** ÐÞ¡¡¸Ä:
                     333     ;** ÈÕ¡¡ÆÚ:
                     334     ;**----------------------------------------------------------------------------------------
                             ---------------
                     335     ;******************************************************************************************
                             **************/
                     336     
----                 337             RSEG  ?PR?LoadCtx?OS_CPU_A
0000                 338     LoadCtx:
                     339             USING   0
                     340                
0000 D000     F      341         POP     Os_Enter_Sum            ;»Ö¸´¹ØÖÐ¶Ï¼ÆÊÆ÷
                     342                                         ;ÅÐ¶ÏÊÇ·ñÐèÒª»Ö¸´ËùÓÐ¼Ä´æÆ÷
0002 E500     F      343         MOV     A,OSTaskID
0004 B40302          344         CJNE    A,#3,LoadCtx_0
0007 8022            345         SJMP    LoadCtx_2
0009                 346     LoadCtx_0:
0009 900000   F      347         MOV     DPTR,#OSMapTbl
                     348     
000C 93              349         MOVC    A,@A+DPTR
000D 5500     F      350         ANL     A,OSFastSwap
                             
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                             
000F 701A            362         JNZ     LoadCtx_2
                     363                                         ;»Ö¸´¼Ä´æÆ÷
0011 D007            364         POP     7
0013 D006            365         POP     6
0015 D005            366         POP     5
0017 D004            367         POP     4
0019 D003            368         POP     3
001B D002            369         POP     2
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     7

001D D001            370         POP     1
001F D000            371         POP     0
0021 D0D0            372         POP     PSW
0023 D082            373         POP     DPL
0025 D083            374         POP     DPH
0027 D0F0            375         POP     B
0029 D0E0            376         POP     ACC
002B                 377     LoadCtx_2:
                     378                                         ;ÅÐ¶ÏÊÇ·ñÐèÒª¿ªÖÐ¶Ï
002B 0500     F      379         INC     Os_Enter_Sum
002D D50002   F      380         djnz    Os_Enter_Sum,LoadCtx_3
                     381         SET_EA                          ;¿ªÖÐ¶Ï
0032                 383     LoadCtx_3:
0032 22              384         RET
                     385     
                     386     ;****************************************************************************************
                     387     ;/*****************************************************************************************
                             ****************
                     388     ;** º¯ÊÃû³Æ: OSCtxSw
                     389     ;** ¹¦ÄÜÃèÊö: ÈÎÎñÖ÷¶¯·ÅÆúCPU»·¾³±£´æº¯Ê
                     390     ;** Êä¡¡Èë: OSTaskID
                     391     ;** Êä¡¡³ö : ÎÞ
                     392     ;** È«¾Ö±äÁ¿: OSFastSwap
                     393     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     394     ;** 
                     395     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     396     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     397     ;**----------------------------------------------------------------------------------------
                             ---------------
                     398     ;** ÐÞ¡¡¸Ä:
                     399     ;** ÈÕ¡¡ÆÚ:
                     400     ;**----------------------------------------------------------------------------------------
                             ---------------
                     401     ;******************************************************************************************
                             **************/
----                 402         RSEG  ?PR?OSCtxSw?OS_CPU_A
0000                 403     OSCtxSw:
                     404         USING       0
                     405                                         ;ÉèÖÃ±êÖ¾£ºÈÎÎñÔÙ´Î»Ö¸´ÔËÐÐÊ±²»±Ø»Ö¸´ËùÓÐ¼Ä´æÆ÷
0000 900000   F      406         MOV     DPTR,#OSMapTbl
0003 E500     F      407         MOV     A,OSTaskID
                     408     
0005 93              409         MOVC    A,@A+DPTR
0006 4500     F      410         ORL     A,OSFastSwap
0008 F500     F      411         MOV     OSFastSwap,A
                             
                                 
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                                 
                                 
                             
000A 020000   F      426         LJMP    C_OSCtxSw
                     427     ;****************************************************************************************
                     428     ;/*****************************************************************************************
                             ****************
                     429     ;** º¯ÊÃû³Æ: C_OSCtxSw
                     430     ;** ¹¦ÄÜÃèÊö: ¶ÑÕ»´¦Àíº¯Ê
                     431     ;** Êä¡¡Èë: ÎÞ
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     8

                     432     ;** Êä¡¡³ö : ÎÞ
                     433     ;** È«¾Ö±äÁ¿: OSTaskID,OSTsakStackBotton,SP
                     434     ;** µ÷ÓÃÄ£¿é: LoadCtx
                     435     ;** 
                     436     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     437     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     438     ;**----------------------------------------------------------------------------------------
                             ---------------
                     439     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
                     440     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     441     ;**----------------------------------------------------------------------------------------
                             ---------------
                     442     ;** ÐÞ¡¡¸Ä:
                     443     ;** ÈÕ¡¡ÆÚ:
                     444     ;**----------------------------------------------------------------------------------------
                             ---------------
                     445     ;******************************************************************************************
                             **************/
----                 446             RSEG  ?PR?C_OSCtxSw?OS_CPU_C
0000                 447     C_OSCtxSw:
0000 C000     F      448         PUSH    Os_Enter_Sum            ;±£´æ¹ØÖÐ¶Ï¼ÆÊÆ÷
0002 AA81            449         mov     r2,sp
                     450         
                     451     ;     cp1 = (unsigned char idata *)SP +1;
0004 A881            452         MOV     R0,SP
                     453     
                     454     IF 0  <> 0
                                 mov     sp,#(Sp2-1)             ;¶ÑÕ»Ö¸ÏòÁÙÊ±¿Õ¼ä£¬ÔÊÐí¡°Èí·ÇÆÁ±ÎÖÐ¶Ï¡±
                             ENDIF
                     457     
0006 08              458         INC     R0
                     459     ;     temp = (unsigned char )OSTsakStackBotton[OSNextTaskID+1];
0007 7400     F      460         MOV     A,#LOW (OSTsakStackBotton+01H)
0009 2500     F      461         ADD     A,OSNextTaskID
000B F9              462         MOV     R1,A
000C E7              463         MOV     A,@R1
000D FF              464         MOV     R7,A
                     465     ;     cp2 = OSTsakStackBotton[OSTaskID+1];
000E 7400     F      466         MOV     A,#LOW (OSTsakStackBotton+01H)
0010 2500     F      467         ADD     A,OSTaskID
0012 F9              468         MOV     R1,A
0013 E7              469         MOV     A,@R1
0014 F9              470         MOV     R1,A
                     471     ;     if( OSNextTaskID > OSTaskID)
0015 E500     F      472         MOV     A,OSNextTaskID
0017 D3              473         SETB    C
0018 9500     F      474         SUBB    A,OSTaskID
001A 4033            475         JC      ?C0001
                     476     ;     {
                     477     ;         while(cp2 != (unsigned char idata *)temp)
                     478     ;         {
                     479     ;             *cp1++ = *cp2++;
                     480     ;         }
001C EF              481         MOV     A,R7
001D C3              482         CLR     C
001E 99              483         SUBB    A,R1
001F FE              484         MOV     R6,A
0020                 485     ?C0002:
0020 E7              486         MOV     A,@R1
0021 F6              487         MOV     @R0,A
0022 08              488         INC     R0
0023 09              489         INC     R1
0024 DEFA            490         DJNZ    R6,?C0002
0026                 491     ?C0003:
                     492     ;         temp = OSTsakStackBotton[OSTaskID+1] - (unsigned char idata *)SP-1;
0026 7400     F      493         MOV     A,#LOW (OSTsakStackBotton+1)
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE     9

0028 2500     F      494         ADD     A,OSTaskID
002A F9              495         MOV     R1,A
002B E7              496         MOV     A,@R1
002C D3              497         SETB    C
                     498         ;SUBB    A,sp
002D 9A              499         SUBB    A,r2
002E FF              500         MOV     R7,A
                     501     ;         SP = (unsigned char )cp1 - 1;
002F 18              502         DEC     R0;
0030 8881            503         MOV     SP,R0
                     504     ;         for(i = OSTaskID+1;i < OSNextTaskID+1; i++)
                     505     ;         {
                     506     ;             OSTsakStackBotton[i] -= temp;
                     507     ;         }
0032 E500     F      508         MOV     A,OSNextTaskID
0034 C3              509         CLR     C
0035 9500     F      510         SUBB    A,OSTaskID
0037 FE              511         MOV     R6,A
0038 600F            512         JZ      ?C0005
                     513     
003A 7400     F      514         MOV     A,#LOW (OSTsakStackBotton)
003C 2500     F      515         ADD     A,OSTaskID
003E F9              516         MOV     R1,A    
003F EF              517         MOV     A,R7
0040 F4              518         CPL     A
0041 04              519         INC     A
0042 FF              520         MOV     R7,A
0043                 521     ?C0004:
0043 09              522         INC     R1
0044 EF              523         MOV     A,R7
0045 27              524         ADD     A,@R1    
0046 F7              525         MOV     @R1,A
0047 DEFA            526         DJNZ    R6,?C0004
0049                 527     ?C0005:
                     528     ;         OSTaskID = OSNextTaskID;
0049 850000   F      529         MOV     OSTaskID,OSNextTaskID
                     530     ;         LoadCtx();    
004C 020000   F      531         LJMP    LoadCtx
                     532     ;     }
004F                 533     ?C0001:
                     534     ; 
                     535     ;     if( OSNextTaskID != OSTaskID)
004F E500     F      536         MOV     A,OSNextTaskID
0051 6500     F      537         XRL     A,OSTaskID
0053 6036            538         JZ      ?C000r
                     539     ;     {
                     540     ;          cp2--;
                     541     ;          cp1--;
                     542     ;         while(cp2 != (unsigned char idata *)temp)
                     543     ;         {
                     544     ;             *cp2-- = *cp1--;
                     545     ;         }
                     546         ;MOV     A,R7
                     547         ;CLR     C
                     548         ;SUBB    A,R1
                     549         ;MOV     R6,A
0055 E8              550         mov     a,r0
0056 C3              551         clr     c
0057 9F              552         subb    a,r7
0058 FE              553         mov     r6,a
0059                 554     ?C0008:
0059 18              555         DEC     R0
005A 19              556         DEC     R1
005B E6              557         MOV     A,@R0
005C F7              558         MOV     @R1,A
005D DEFA            559         DJNZ    R6,?C0008
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE    10

005F                 560     ?C0009:
                     561     ;         temp = OSTsakStackBotton[OSTaskID+1] - (unsigned char idata *)SP-1;
005F 7400     F      562         MOV     A,#LOW (OSTsakStackBotton+01H)
0061 2500     F      563         ADD     A,OSTaskID
0063 F9              564         MOV     R1,A
0064 E7              565         MOV     A,@R1
0065 D3              566         SETB    C
                     567         ;SUBB    A,SP
0066 9A              568         SUBB    A,r2
0067 FF              569         MOV     R7,A
                     570     ;         SP = (unsigned char )OSTsakStackBotton[OSNextTaskID+1];
0068 7400     F      571         MOV     A,#LOW (OSTsakStackBotton+01H)
006A 2500     F      572         ADD     A,OSNextTaskID
006C F9              573         MOV     R1,A
006D E7              574         MOV     A,@R1
006E F581            575         MOV     SP,A
                     576     ;         for(i = OSNextTaskID+1;i < OSTaskID+1; i++)
                     577     ;         {
                     578     ;             OSTsakStackBotton[i] += temp;
                     579     ;         }
                     580     
0070 E500     F      581         MOV     A,OSTaskID
0072 C3              582         CLR     C
0073 9500     F      583         SUBB    A,OSNextTaskID
0075 600C            584         JZ      ?C0011
                     585     
0077 FE              586         MOV     R6,A
0078 7400     F      587         MOV     A,#LOW (OSTsakStackBotton)
007A 2500     F      588         ADD     A,OSNextTaskID
007C F9              589         MOV     R1,A    
007D                 590     ?C0010:
007D 09              591         INC     R1
007E EF              592         MOV     A,R7
007F 27              593         ADD     A,@R1    
0080 F7              594         MOV     @R1,A
0081 DEFA            595         DJNZ    R6,?C0010
                     596     
0083                 597     ?C0011:
                     598     ;         OSTaskID = OSNextTaskID;        
0083 850000   F      599         MOV         OSTaskID,OSNextTaskID
                     600     ;         SP--;
0086 1581            601         DEC         SP
                     602     ;     }
0088                 603     ?C0007:
                     604     ;     LoadCtx();
0088 020000   F      605         LJMP        LoadCtx
008B                 606     ?C000r:
                     607     IF 0  <> 0
                                 mov     SP,r2
                             ENDIF
008B 020000   F      610         LJMP        LoadCtx
                     611     ;****************************************************************************************
                     612     ;/*****************************************************************************************
                             ****************
                     613     ;** º¯ÊÃû³Æ: OSIntCtxSw
                     614     ;** ¹¦ÄÜÃèÊö: ÖÐ¶ÏÊ¹ÈÎÎñ·ÅÆúCPU»·¾³±£´æº¯Ê
                     615     ;** Êä¡¡Èë: OSTaskID
                     616     ;** Êä¡¡³ö : ÎÞ
                     617     ;** È«¾Ö±äÁ¿: OSFastSwap
                     618     ;** µ÷ÓÃÄ£¿é: ÎÞ
                     619     ;** 
                     620     ;** ×÷¡¡Õß: ³ÂÃ÷¼Æ
                     621     ;** ÈÕ¡¡ÆÚ: 2002Äê2ÔÂ22ÈÕ
                     622     ;**----------------------------------------------------------------------------------------
                             ---------------
                     623     ;** ÐÞ¡¡¸Ä: ³ÂÃ÷¼Æ
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE    11

                     624     ;** ÈÕ¡¡ÆÚ: 2002Äê12ÔÂ2ÈÕ
                     625     ;**----------------------------------------------------------------------------------------
                             ---------------
                     626     ;** ÐÞ¡¡¸Ä:
                     627     ;** ÈÕ¡¡ÆÚ:
                     628     ;**----------------------------------------------------------------------------------------
                             ---------------
                     629     ;******************************************************************************************
                             **************/
----                 630             RSEG  ?PR?OSIntCtxSw?OS_CPU_A
0000                 631     OSIntCtxSw:
                     632             USING   0
                     633                                             ;ÊÇ·ñÊÇÓÅÏÈ¼¶×îµÍÈÎÎñ
0000 7403            634         MOV     A,#3
0002 6500     F      635         XRL     A,OSTaskID
0004 700F            636         JNZ     OSIntCtxSw_0
                     637                                             ;ÊÇÔò²»ÐèÒª±£´æËùÓÐ¼Ä´æÆ÷
                     638     ;SP=SP-13-4                             ;4:Á½²ãº¯Êµ÷ÓÃ¶ÑÕ»£¬13£º¼Ä´æÆ÷ÊÄ¿
0006 74EF            639         MOV     A,#(-17)
0008 2581            640         ADD     A,SP
000A F581            641         MOV     SP,A
                     642                                             ;Ìø×ªµ½OSCtxSw£¬Í¬Ê±Í¨ÖªCPUÖÐ¶Ï´¦ÀíÍê³É
000C 7400     F      643         MOV     A, #LOW  OSCtxSw
000E C0E0            644         PUSH    ACC
0010 7400     F      645         MOV     A, #HIGH OSCtxSw
0012 C0E0            646         PUSH    ACC
0014 32              647         RETI
                     648                                             ;ÐèÒª±£´æËùÓÐ¼Ä´æÆ÷
0015                 649     OSIntCtxSw_0:
                     650     ;SP=SP-4                                ;4:Á½²ãº¯Êµ÷ÓÃ¶ÑÕ»
0015 74FC            651         MOV     A,#0FCH
0017 2581            652         ADD     A,SP
0019 F581            653         MOV     SP,A
                     654                                             ;ÉèÖÃ±êÖ¾£ºÈÎÎñÔÙ´Î»Ö¸´ÔËÐÐÊ±ÐèÒª»Ö¸´ËùÓÐ¼Ä´æÆ÷
001B 900000   F      655         MOV     DPTR,#OSMapTbl
001E E500     F      656         MOV     A,OSTaskID
                     657     
0020 93              658         MOVC    A,@A+DPTR
0021 F4              659         CPL     A
0022 5500     F      660         ANL     A,OSFastSwap
0024 F500     F      661         MOV     OSFastSwap,A    
                             
                                 
                                 
                                 
                                 
                                 
                                 
                                 
                                 
                             
                                 
                                 
                                 
                                 
                                 
                             
                             
                     679                                             ;Ìø×ªµ½¶ÑÕ»´¦Àí£¬Í¬Ê±Í¨ÖªCPUÖÐ¶Ï´¦ÀíÍê³É
0026 7400     F      680         MOV     A, #LOW  C_OSCtxSw
0028 C0E0            681         PUSH    ACC
002A 7400     F      682         MOV     A, #HIGH C_OSCtxSw
002C C0E0            683         PUSH    ACC
002E 32              684         RETI
                     685     
                     686     ;****************************************************************************************
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE    12

                     687             END
A51 MACRO ASSEMBLER  OS_CPU_A                                                             07/17/2015 00:08:39 PAGE    13

SYMBOL TABLE LISTING
------ ----- -------


N A M E                  T Y P E  V A L U E   ATTRIBUTES

?C0001. . . . . . . . .  C ADDR   004FH   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0002. . . . . . . . .  C ADDR   0020H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0003. . . . . . . . .  C ADDR   0026H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0004. . . . . . . . .  C ADDR   0043H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0005. . . . . . . . .  C ADDR   0049H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0007. . . . . . . . .  C ADDR   0088H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0008. . . . . . . . .  C ADDR   0059H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0009. . . . . . . . .  C ADDR   005FH   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C000R. . . . . . . . .  C ADDR   008BH   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0010. . . . . . . . .  C ADDR   007DH   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?C0011. . . . . . . . .  C ADDR   0083H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
?PR?C_OSCTXSW?OS_CPU_C.  C SEG    008EH       REL=UNIT
?PR?LOADCTX?OS_CPU_A. .  C SEG    0033H       REL=UNIT
?PR?OSCTXSW?OS_CPU_A. .  C SEG    000DH       REL=UNIT
?PR?OSINTCTXSW?OS_CPU_A  C SEG    002FH       REL=UNIT
?STACK. . . . . . . . .  I SEG    0001H       REL=UNIT
ACC . . . . . . . . . .  D ADDR   00E0H   A   
B . . . . . . . . . . .  D ADDR   00F0H   A   
C_OSCTXSW . . . . . . .  C ADDR   0000H   R   SEG=?PR?C_OSCTXSW?OS_CPU_C
DPH . . . . . . . . . .  D ADDR   0083H   A   
DPL . . . . . . . . . .  D ADDR   0082H   A   
EA. . . . . . . . . . .  B ADDR   00A8H.7 A   
LOADCTX . . . . . . . .  C ADDR   0000H   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_0 . . . . . . .  C ADDR   0009H   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_2 . . . . . . .  C ADDR   002BH   R   SEG=?PR?LOADCTX?OS_CPU_A
LOADCTX_3 . . . . . . .  C ADDR   0032H   R   SEG=?PR?LOADCTX?OS_CPU_A
OSCTXSW . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSCTXSW?OS_CPU_A
OSFASTSWAP. . . . . . .  D ADDR   -----       EXT
OSINTCTXSW. . . . . . .  C ADDR   0000H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSINTCTXSW_0. . . . . .  C ADDR   0015H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSMAPTBL. . . . . . . .  C ADDR   -----       EXT
OSNEXTTASKID. . . . . .  D ADDR   -----       EXT
OSTASKID. . . . . . . .  D ADDR   -----       EXT
OSTSAKSTACKBOTTON . . .  D ADDR   -----       EXT
OS_CPU_A_ASM. . . . . .  N NUMB   -----       
OS_ENTER_SUM. . . . . .  D ADDR   -----       EXT
PSW . . . . . . . . . .  D ADDR   00D0H   A   
SP. . . . . . . . . . .  D ADDR   0081H   A   
STACK . . . . . . . . .  I ADDR   0000H   R   SEG=?STACK


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
